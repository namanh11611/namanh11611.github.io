<!doctype html><html lang=vi dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Trong bài viết trước Bộ nhớ Stack và Heap trong Java, mình đã nhắc đến Memory Leaks như là một phần gây ra lỗi java.lang.OutOfMemoryError. Vậy thì hôm nay chúng ta sẽ dành thời gian tìm hiểu những ví dụ cụ thể gây ra Memory Leaks để biết cách phòng bệnh và chữa bệnh."><title>Bác sỹ IT bắt bệnh những trường hợp gây Memory Leak trong Android</title><link rel=canonical href=https://namanh11611.github.io/vi/p/memory-leak/><link rel=stylesheet href=/scss/style.min.833d6eed45de56f48306bf57268d5b8cdfc8a60e8e7bdc99810464fcd033f7c6.css><meta property='og:title' content="Bác sỹ IT bắt bệnh những trường hợp gây Memory Leak trong Android"><meta property='og:description' content="Trong bài viết trước Bộ nhớ Stack và Heap trong Java, mình đã nhắc đến Memory Leaks như là một phần gây ra lỗi java.lang.OutOfMemoryError. Vậy thì hôm nay chúng ta sẽ dành thời gian tìm hiểu những ví dụ cụ thể gây ra Memory Leaks để biết cách phòng bệnh và chữa bệnh."><meta property='og:url' content='https://namanh11611.github.io/vi/p/memory-leak/'><meta property='og:site_name' content='Henry Techie'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Memory Leak'><meta property='article:tag' content='Heap'><meta property='article:tag' content='Android'><meta property='article:tag' content='Java'><meta property='article:published_time' content='2025-05-11T11:00:00+07:00'><meta property='article:modified_time' content='2025-05-11T11:00:00+07:00'><meta property='og:image' content='https://namanh11611.github.io/p/memory-leak/memory_leak.webp'><meta name=twitter:title content="Bác sỹ IT bắt bệnh những trường hợp gây Memory Leak trong Android"><meta name=twitter:description content="Trong bài viết trước Bộ nhớ Stack và Heap trong Java, mình đã nhắc đến Memory Leaks như là một phần gây ra lỗi java.lang.OutOfMemoryError. Vậy thì hôm nay chúng ta sẽ dành thời gian tìm hiểu những ví dụ cụ thể gây ra Memory Leaks để biết cách phòng bệnh và chữa bệnh."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://namanh11611.github.io/p/memory-leak/memory_leak.webp'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Hiển thị Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/vi/><img src=/img/avatar_hu_99416cdbb1f5ed1b.webp width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/vi>Henry Techie</a></h1><h2 class=site-description>Software Engineer</h2></div></header><ol class=menu-social><li><a href=https://linkedin.com/in/namanh11611 target=_blank title=LinkedIn rel=me><svg class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4m0 2a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2z"/><path d="M8 11v5"/><path d="M8 8v.01"/><path d="M12 16v-5"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></a></li><li><a href=https://github.com/namanh11611 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://viblo.asia/u/namanh11611 target=_blank title=Viblo rel=me><svg class="icon icon-tabler icon-tabler-letter-v" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 4l6 16 6-16"/></svg></a></li><li><a href=https://twitter.com/namanh11611 target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://facebook.com/namanh11611 target=_blank title=Facebook rel=me><svg class="icon icon-tabler icon-tabler-brand-facebook" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 10v4h3v7h4v-7h3l1-4h-4V8a1 1 0 011-1h3V3h-3a5 5 0 00-5 5v2H7"/></svg></a></li></ol><ol class=menu id=main-menu><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://namanh11611.github.io/>English</option><option value=https://namanh11611.github.io/vi/ selected>Tiếng Việt</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Chế độ nền tối</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Mục lục</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#static-reference-đến-context>Static Reference đến Context</a></li><li><a href=#inner-class-non-static>Inner Class (Non-Static)</a></li><li><a href=#quên-unregister-listener>Quên unregister listener</a></li><li><a href=#long-running-async-task-hoặc-thread>Long-Running Async Task hoặc Thread</a></li><li><a href=#lời-kết>Lời kết</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/vi/p/memory-leak/><img src=/p/memory-leak/memory_leak_hu_62ba23f952a376b6.webp srcset="/p/memory-leak/memory_leak_hu_62ba23f952a376b6.webp 800w, /p/memory-leak/memory_leak_hu_5964dedd9822fe8.webp 1600w" width=800 height=533 loading=lazy alt="Featured image of post Bác sỹ IT bắt bệnh những trường hợp gây Memory Leak trong Android"></a></div><div class=article-details><header class=article-category><a href=/vi/categories/technical/ style=background-color:#e60f41;color:#fff>Technical
</a><a href=/vi/categories/android/ style=background-color:#048665;color:#fff>Android</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/vi/p/memory-leak/>Bác sỹ IT bắt bệnh những trường hợp gây Memory Leak trong Android</a></h2><h3 class=article-subtitle>Trong bài viết trước Bộ nhớ Stack và Heap trong Java, mình đã nhắc đến Memory Leaks như là một phần gây ra lỗi java.lang.OutOfMemoryError. Vậy thì hôm nay chúng ta sẽ dành thời gian tìm hiểu những ví dụ cụ thể gây ra Memory Leaks để biết cách phòng bệnh và chữa bệnh.</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-05-11T11:00:00+07:00>thg 5 11, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>4 phút đọc</time></div></footer><footer class=article-translations><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://namanh11611.github.io/p/memory-leak/ class=link>English</a></div></footer></div></header><section class=article-content><p><em>Photo by <a class=link href="https://unsplash.com/@worldsbetweenlines?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" target=_blank rel=noopener>Patrick Hendry</a> on <a class=link href="https://unsplash.com/photos/brown-rocks-on-body-of-water-9wnabOhABno?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" target=_blank rel=noopener>Unsplash</a></em></p><p>Trong bài viết trước <a class=link href=../stack-heap><strong>Bộ nhớ Stack và Heap trong Java</strong></a>, mình đã nhắc đến <strong>Memory Leaks</strong> như là một phần gây ra lỗi <code>java.lang.OutOfMemoryError</code>. Vậy thì hôm nay chúng ta sẽ dành thời gian tìm hiểu những ví dụ cụ thể gây ra Memory Leaks để biết cách phòng bệnh và chữa bệnh. Nào, xin mời các bác sỹ IT bắt tay vào hội chẩn từng ca bệnh một.</p><h1 id=static-reference-đến-context>Static Reference đến Context</h1><p>Trong quá trình code, đôi khi do sơ suất mà bạn khai báo <code>Activity</code> hoặc <code>Context</code> như một biến static. Việc này sẽ khiến chúng ta giữ một reference đến <code>Activity</code> hoặc <code>Context</code> trong biến static đó, làm cho <strong>Garbage Collector</strong> không thể thu hồi bộ nhớ và dẫn đến memory leak. Bạn có thể đọc lại về cơ chế hoạt động của <strong>Garbage Collector</strong> trong <a class=link href=../stack-heap>bài viết này</a>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>MemoryLeakExample</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>companion</span> <span class=k>object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>var</span> <span class=py>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>  <span class=c1>// Static reference to Context
</span></span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>initialize</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>context</span> <span class=p>=</span> <span class=n>context</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>object</span> <span class=nc>MySingleton</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>var</span> <span class=py>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Để khắc phục, bạn có thể sử dụng <code>applicationContext</code> thay vì <code>context</code> của <code>Activity</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>MemorySafeExample</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>companion</span> <span class=k>object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>var</span> <span class=py>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>initialize</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=n>context</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>applicationContext</span>  <span class=c1>// Use applicationContext instead of Activity context
</span></span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Hoặc nếu bắt buộc phải lưu <code>context</code> trong singleton/static, bạn có thể sử dụng <code>WeakReference</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>object</span> <span class=nc>MySingleton</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>var</span> <span class=py>weakContext</span><span class=p>:</span> <span class=n>WeakReference</span><span class=p>&lt;</span><span class=n>Context</span><span class=p>&gt;?</span> <span class=p>=</span> <span class=k>null</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>setContext</span><span class=p>(</span><span class=n>context</span><span class=p>:</span> <span class=n>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>weakContext</span> <span class=p>=</span> <span class=n>WeakReference</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=n>applicationContext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>fun</span> <span class=nf>getContext</span><span class=p>():</span> <span class=n>Context</span><span class=p>?</span> <span class=p>=</span> <span class=n>weakContext</span><span class=o>?.</span><span class=k>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=inner-class-non-static>Inner Class (Non-Static)</h1><p>Inner class luôn mang theo reference ngầm đến outer class. Do đó, nếu <code>Handler</code>, <code>Runnable</code>&mldr; trong inner class tiếp tục tồn tại sau khi <code>Activity</code> bị hủy thì sẽ dẫn đến memory leak.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>MainActivity</span> <span class=p>:</span> <span class=n>AppCompatActivity</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>handler</span> <span class=p>=</span> <span class=n>Handler</span><span class=p>(</span><span class=nc>Looper</span><span class=p>.</span><span class=n>getMainLooper</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>handler</span><span class=p>.</span><span class=n>postDelayed</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Code that refers to activity
</span></span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Cách khắc phục cũng tương tự như phần trên, đó là chúng ta có thể dùng <code>WeakReference</code> hoặc static inner class.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>MainActivity</span> <span class=p>:</span> <span class=n>AppCompatActivity</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>val</span> <span class=py>handler</span> <span class=p>=</span> <span class=n>Handler</span><span class=p>(</span><span class=nc>Looper</span><span class=p>.</span><span class=n>getMainLooper</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>weakActivity</span> <span class=p>=</span> <span class=n>WeakReference</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>handler</span><span class=p>.</span><span class=n>postDelayed</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=n>weakActivity</span><span class=p>.</span><span class=k>get</span><span class=p>()</span><span class=o>?.</span><span class=n>let</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Safe usage of activity
</span></span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=quên-unregister-listener>Quên unregister listener</h1><p>Việc quên unregister listener hoặc <code>BroadcastReceiver</code> sau khi <code>Activity</code>/<code>Fragment</code> huỷ có thể làm cho activity không được <strong>Garbage Collector</strong> thu hồi.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>MainActivity</span> <span class=p>:</span> <span class=n>AppCompatActivity</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>lateinit</span> <span class=k>var</span> <span class=py>receiver</span><span class=p>:</span> <span class=n>BroadcastReceiver</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>receiver</span> <span class=p>=</span> <span class=n>BroadcastReceiver</span> <span class=p>{</span> <span class=n>context</span><span class=p>,</span> <span class=n>intent</span> <span class=o>-&gt;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>registerReceiver</span><span class=p>(</span><span class=k>receiver</span><span class=p>,</span> <span class=n>IntentFilter</span><span class=p>(</span><span class=s2>&#34;com.example.MY_ACTION&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Forgot to unregister receiver
</span></span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Vì vậy bạn hãy nhớ luôn luôn unregister listener/receiver trong <code>onDestroy()</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>class</span> <span class=nc>MainActivity</span> <span class=p>:</span> <span class=n>AppCompatActivity</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>lateinit</span> <span class=k>var</span> <span class=py>receiver</span><span class=p>:</span> <span class=n>BroadcastReceiver</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>:</span> <span class=n>Bundle</span><span class=p>?)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onCreate</span><span class=p>(</span><span class=n>savedInstanceState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>receiver</span> <span class=p>=</span> <span class=n>BroadcastReceiver</span> <span class=p>{</span> <span class=n>context</span><span class=p>,</span> <span class=n>intent</span> <span class=o>-&gt;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>registerReceiver</span><span class=p>(</span><span class=k>receiver</span><span class=p>,</span> <span class=n>IntentFilter</span><span class=p>(</span><span class=s2>&#34;com.example.MY_ACTION&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>override</span> <span class=k>fun</span> <span class=nf>onDestroy</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>super</span><span class=p>.</span><span class=n>onDestroy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>unregisterReceiver</span><span class=p>(</span><span class=k>receiver</span><span class=p>)</span>  <span class=c1>// Unregister when activity is destroyed
</span></span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=long-running-async-task-hoặc-thread>Long-Running Async Task hoặc Thread</h1><p>Các background task như <code>coroutine</code>, <code>thread</code> hoặc <code>Runnable</code> tiếp tục chạy sau khi <code>Activity</code> bị huỷ và còn giữ tham chiếu đến <code>Activity</code> cũ cũng là nguyên nhân thường gặp gây memory leak.</p><p>Chúng ta có một số giải pháp cho trường hợp này như:</p><ul><li>Hãy cancel coroutine/async task trong onDestroy()</li><li>Dùng lifecycleScope/viewModelScope để tự động cancel task khi lifecycle kết thúc</li></ul><h1 id=lời-kết>Lời kết</h1><p>Ngoài việc ghi nhớ và áp dụng những best practice ở trên, bạn cũng có thể sử dụng công cụ hỗ trợ như <strong>LeakCanary</strong> hoặc <strong>Memory Profiler</strong> trong Android Studio để theo dõi và debug memory leak. Việc hiểu đúng và tránh memory leak sẽ giúp app Android của bạn tiết kiệm RAM và chạy ổn định hơn.</p></section><footer class=article-footer><section class=article-tags><a href=/vi/tags/memory-leak/>Memory Leak</a>
<a href=/vi/tags/heap/>Heap</a>
<a href=/vi/tags/android/>Android</a>
<a href=/vi/tags/java/>Java</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Bài viết liên quan</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/vi/p/stack-heap/><div class=article-image><img src=/p/stack-heap/stack-heap.535e501ab32584a4f316eddc0ddad1a7_hu_3427b8bfd2242918.webp width=250 height=150 loading=lazy alt="Featured image of post Bộ nhớ Stack và Heap trong Java" data-key=stack-heap data-hash="md5-U15QGrMlhKTzFu3cDdrRpw=="></div><div class=article-details><h2 class=article-title>Bộ nhớ Stack và Heap trong Java</h2></div></a></article><article class=has-image><a href=/vi/p/looper-message-queue-handler/><div class=article-image><img src=/p/looper-message-queue-handler/looper_message_queue_handler.389584b807ebe3ac4a61a20690b97265_hu_d6620fbeef504e69.webp width=250 height=150 loading=lazy alt="Featured image of post Tất tần tật về Looper, MessageQueue và Handler trong Android" data-key=looper-message-queue-handler data-hash="md5-OJWEuAfr46xKYaIGkLlyZQ=="></div><div class=article-details><h2 class=article-title>Tất tần tật về Looper, MessageQueue và Handler trong Android</h2></div></a></article><article class=has-image><a href=/vi/p/kotlin-flow-cheat-sheet-3/><div class=article-image><img src=/p/kotlin-flow-cheat-sheet-3/cheat_sheet.693580b63998c07c78483b5a2f6bbda9_hu_e378eacd4945636.webp width=250 height=150 loading=lazy alt="Featured image of post Kotlin Flow cheat sheet phần 3: SharedFlow và StateFlow" data-key=kotlin-flow-cheat-sheet-3 data-hash="md5-aTWAtjmYwHx4SDtaL2u9qQ=="></div><div class=article-details><h2 class=article-title>Kotlin Flow cheat sheet phần 3: SharedFlow và StateFlow</h2></div></a></article><article class=has-image><a href=/vi/p/kotlin-flow-cheat-sheet-2/><div class=article-image><img src=/p/kotlin-flow-cheat-sheet-2/cheat_sheet.693580b63998c07c78483b5a2f6bbda9_hu_e378eacd4945636.webp width=250 height=150 loading=lazy alt="Featured image of post Kotlin Flow cheat sheet phần 2: Flow" data-key=kotlin-flow-cheat-sheet-2 data-hash="md5-aTWAtjmYwHx4SDtaL2u9qQ=="></div><div class=article-details><h2 class=article-title>Kotlin Flow cheat sheet phần 2: Flow</h2></div></a></article><article class=has-image><a href=/vi/p/kotlin-flow-cheat-sheet-1/><div class=article-image><img src=/p/kotlin-flow-cheat-sheet-1/cheat_sheet.693580b63998c07c78483b5a2f6bbda9_hu_e378eacd4945636.webp width=250 height=150 loading=lazy alt="Featured image of post Kotlin Flow cheat sheet phần 1: Channel" data-key=kotlin-flow-cheat-sheet-1 data-hash="md5-aTWAtjmYwHx4SDtaL2u9qQ=="></div><div class=article-details><h2 class=article-title>Kotlin Flow cheat sheet phần 1: Channel</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//henry-techie.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2019 -
2026 Henry Techie</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.33.0>Stack</a></b> thiết kế bởi <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script data-goatcounter=https://henry-techie.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html>
<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Cheat sheet này hệ thống lại những kiến thức quan trọng mà mình đã góp nhặt được trong quá trình làm việc với Kotlin Coroutines. Nó được thiết kế để trở thành một tài liệu tham khảo hữu ích, giúp anh em giải quyết các trường hợp phức tạp của coroutine."><title>Kotlin Coroutines cheat sheet nâng cao dành cho Android Engineer</title><link rel=canonical href=https://namanh11611.github.io/p/kotlin-coroutines-cheat-sheet/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="Kotlin Coroutines cheat sheet nâng cao dành cho Android Engineer"><meta property='og:description' content="Cheat sheet này hệ thống lại những kiến thức quan trọng mà mình đã góp nhặt được trong quá trình làm việc với Kotlin Coroutines. Nó được thiết kế để trở thành một tài liệu tham khảo hữu ích, giúp anh em giải quyết các trường hợp phức tạp của coroutine."><meta property='og:url' content='https://namanh11611.github.io/p/kotlin-coroutines-cheat-sheet/'><meta property='og:site_name' content='Henry Techie'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Kotlin'><meta property='article:tag' content='Android'><meta property='article:tag' content='Coroutines'><meta property='article:published_time' content='2024-08-12T00:00:00+07:00'><meta property='article:modified_time' content='2024-08-12T00:00:00+07:00'><meta property='og:image' content='https://namanh11611.github.io/p/kotlin-coroutines-cheat-sheet/cheat_sheet.webp'><meta name=twitter:title content="Kotlin Coroutines cheat sheet nâng cao dành cho Android Engineer"><meta name=twitter:description content="Cheat sheet này hệ thống lại những kiến thức quan trọng mà mình đã góp nhặt được trong quá trình làm việc với Kotlin Coroutines. Nó được thiết kế để trở thành một tài liệu tham khảo hữu ích, giúp anh em giải quyết các trường hợp phức tạp của coroutine."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://namanh11611.github.io/p/kotlin-coroutines-cheat-sheet/cheat_sheet.webp'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_94a738b6dc80b619.webp width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Henry Techie</a></h1><h2 class=site-description>Software Engineer</h2></div></header><ol class=menu-social><li><a href=https://linkedin.com/in/namanh11611 target=_blank title=LinkedIn rel=me><svg class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4m0 2a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2z"/><path d="M8 11v5"/><path d="M8 8v.01"/><path d="M12 16v-5"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></a></li><li><a href=https://github.com/namanh11611 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://viblo.asia/u/namanh11611 target=_blank title=Viblo rel=me><svg class="icon icon-tabler icon-tabler-letter-v" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 4l6 16 6-16"/></svg></a></li><li><a href=https://twitter.com/namanh11611 target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://facebook.com/namanh11611 target=_blank title=Facebook rel=me><svg class="icon icon-tabler icon-tabler-brand-facebook" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 10v4h3v7h4v-7h3l1-4h-4V8a1 1 0 011-1h3V3h-3a5 5 0 00-5 5v2H7"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about-me/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About Me</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://namanh11611.github.io/ selected>English</option><option value=https://namanh11611.github.io/vi/>Tiếng Việt</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#các-khái-niệm-trong-coroutines>Các khái niệm trong Coroutines</a></li><li><a href=#các-quy-tắc-chính-của-coroutines>Các quy tắc chính của Coroutines</a></li><li><a href=#các-function-của-coroutine-scope>Các function của Coroutine scope</a></li><li><a href=#chạy-song-song>Chạy song song</a><ol><li><a href=#khi-bạn-có-quyền-truy-cập-vào-một-scope-ví-dụ-từ-viewmodel>Khi bạn có quyền truy cập vào một scope (ví dụ từ ViewModel)</a></li><li><a href=#khi-bạn-không-có-quyền-truy-cập-vào-một-scope-ví-dụ-từ-một-repository>Khi bạn không có quyền truy cập vào một scope (ví dụ từ một repository)</a></li></ol></li><li><a href=#dọn-dẹp-khi-coroutine-bị-cancel>Dọn dẹp khi Coroutine bị cancel</a></li><li><a href=#dọn-dẹp-coroutine-khi-hoàn-thành>Dọn dẹp Coroutine khi hoàn thành</a></li><li><a href=#làm-cách-nào-để-không-cancel-coroutine-khi-một-trong-các-phần-tử-con-của-nó-bị-lỗi>Làm cách nào để KHÔNG cancel Coroutine khi một trong các phần tử con của nó bị lỗi</a><ol><li><a href=#tạo-coroutine-scope-của-bạn>Tạo coroutine scope của bạn</a></li><li><a href=#sử-dụng-scope-function>Sử dụng scope function</a></li><li><a href=#bắt-exception>Bắt exception</a></li></ol></li><li><a href=#định-nghĩa-tác-vụ-mặc-định-trong-trường-hợp-có-exception>Định nghĩa tác vụ mặc định trong trường hợp có exception</a></li><li><a href=#chạy-một-tác-vụ-không-cần-thiết>Chạy một tác vụ không cần thiết</a></li><li><a href=#chạy-một-tác-vụ-trên-single-thread-để-tránh-các-sự-cố-đồng-bộ>Chạy một tác vụ trên single thread để tránh các sự cố đồng bộ</a><ol><li><a href=#các-cách-tiếp-cận-khác-để-tránh-sự-cố-đồng-bộ-hóa-với-multithreading>Các cách tiếp cận khác để tránh sự cố đồng bộ hóa với multithreading</a></li></ol></li><li><a href=#tránh-gửi-lại-một-coroutine-đến-cùng-một-dispatcher>Tránh gửi lại một coroutine đến cùng một dispatcher</a></li><li><a href=#reference>Reference</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/kotlin-coroutines-cheat-sheet/><img src=/p/kotlin-coroutines-cheat-sheet/cheat_sheet_hu_b192923ec7a53357.webp srcset="/p/kotlin-coroutines-cheat-sheet/cheat_sheet_hu_b192923ec7a53357.webp 800w, /p/kotlin-coroutines-cheat-sheet/cheat_sheet_hu_35135b1ed4bf7ae3.webp 1600w" width=800 height=533 loading=lazy alt="Featured image of post Kotlin Coroutines cheat sheet nâng cao dành cho Android Engineer"></a></div><div class=article-details><header class=article-category><a href=/categories/technical/ style=background-color:#e60f41;color:#fff>Technical
</a><a href=/categories/android/ style=background-color:#048665;color:#fff>Android</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/kotlin-coroutines-cheat-sheet/>Kotlin Coroutines cheat sheet nâng cao dành cho Android Engineer</a></h2><h3 class=article-subtitle>Cheat sheet này hệ thống lại những kiến thức quan trọng mà mình đã góp nhặt được trong quá trình làm việc với Kotlin Coroutines. Nó được thiết kế để trở thành một tài liệu tham khảo hữu ích, giúp anh em giải quyết các trường hợp phức tạp của coroutine.</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Aug 12, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>10 minute read</time></div></footer><footer class=article-translations><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://namanh11611.github.io/vi/p/kotlin-coroutines-cheat-sheet/ class=link>Tiếng Việt</a></div></footer></div></header><section class=article-content><p><em>Photo by <a class=link href="https://unsplash.com/@anacruzbaeza?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" target=_blank rel=noopener>Ana Cruz</a> on <a class=link href="https://unsplash.com/photos/photographie-a-plat-de-papiers-dimprimante-blancs-S0qh0ONK-AE?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" target=_blank rel=noopener>Unsplash</a></em></p><p>Sau khi làm việc với <strong>Kotlin Coroutines</strong> một thời gian, có thể anh em đã quen với các khái niệm cơ bản như <code>suspend</code> function và các hàm <code>launch</code>, <code>async</code>&mldr;, có thể giải quyết các use case đơn giản một cách ngon ơ. Nhưng khi dự án trở nên phức tạp hơn, anh em có thể thường xuyên cần các giải pháp nâng cao hơn và phải nhờ sự trợ giúp đến từ Google hoặc AI.</p><p>Cheat sheet này hệ thống lại những kiến thức quan trọng mà mình đã góp nhặt được trong quá trình làm việc với <strong>Kotlin Coroutines</strong>. Nó được thiết kế để trở thành một tài liệu tham khảo hữu ích, giúp anh em giải quyết các trường hợp phức tạp của coroutine.</p><p>Bạn có thể đọc toàn bộ serie tại đây:</p><ul><li>Kotlin Coroutines cheat sheet nâng cao dành cho Android Engineer</li><li><a class=link href=../kotlin-flow-cheat-sheet-1>Kotlin Flow cheat sheet phần 1: Channel</a></li><li><a class=link href=../kotlin-flow-cheat-sheet-2>Kotlin Flow cheat sheet phần 2: Flow</a></li><li><a class=link href=../kotlin-flow-cheat-sheet-3>Kotlin Flow cheat sheet phần 3: SharedFlow và StateFlow</a></li></ul><h1 id=các-khái-niệm-trong-coroutines>Các khái niệm trong Coroutines</h1><p><a class=link href=https://kotlinlang.org/docs/coroutine-context-and-dispatchers.html target=_blank rel=noopener><strong>Coroutine Context</strong></a>: tập hợp các thành phần khác nhau. Trong đó, các thành phần chính là <strong>Job</strong> và <strong>Dispatcher</strong> của coroutine.</p><p><a class=link href=https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-job/ target=_blank rel=noopener><strong>Job</strong></a>: thứ có thể hủy được với vòng đời đạt đến đỉnh khi nó hoàn thành. Mỗi coroutine đều tạo một <strong>Job</strong> của riêng nó (đó là <strong>coroutine context duy nhất</strong> không được kế thừa từ coroutine cha).</p><p><strong>Dispatcher</strong>: cho phép chúng ta quyết định <strong>thread</strong> nào (hoặc pool của thread) mà coroutine sẽ chạy trên đó (khi start và resume). Bạn có thể đọc bài viết chi tiết của mình về <a class=link href=../kotlin-coroutines-dispatchers>Dispatchers trong Kotlin Coroutines</a></p><p><strong>Coroutine scope</strong>: xác định thời gian tồn tại và context của coroutine. Nó chịu trách nhiệm quản lý vòng đời của coroutine, bao gồm cả việc hủy và xử lý lỗi.</p><p><strong>Coroutine builder</strong>: các <strong>extension function</strong> của <code>CoroutineScope</code>, cho phép chúng ta start một coroutine bất đồng bộ (ví dụ như <code>launch</code>, <code>async</code>… ).</p><h1 id=các-quy-tắc-chính-của-coroutines>Các quy tắc chính của Coroutines</h1><ul><li>Bạn cần một <code>CoroutineScope</code> để start một coroutine (với function <code>launch</code> hoặc <code>async</code>). <strong><code>viewModelScope</code></strong> được sử dụng phổ biến nhất trong Android, nhưng bạn cũng có thể tự xây dựng scope của riêng bạn.</li><li><strong>Coroutine con</strong> (một coroutine bắt đầu từ một coroutine khác) <strong>kế thừa</strong> coroutine context từ <strong>coroutine cha</strong> (ngoại trừ <strong>Job</strong>).</li><li><strong>Job</strong> của <strong>coroutine cha</strong> được sử dụng làm <strong>cha</strong> của <strong>Job</strong> của <strong>coroutine con</strong>.</li><li><strong>Coroutine cha suspend</strong> cho đến khi tất cả các <strong>coroutine con</strong> của nó <strong>kết thúc</strong>.</li><li>Khi một <strong>coroutine cha</strong> bị <strong>hủy</strong> thì tất cả các <strong>coroutine con</strong> của nó cũng bị <strong>hủy</strong>.</li><li>Khi một <strong>coroutine con</strong> bị lỗi vì một Exception chưa được xử lý, nó sẽ <strong>cancel coroutine cha</strong> của nó (trừ khi bạn sử dụng một <code>SupervisorJob</code>).</li><li>Bạn không nên sử dụng <code>GlobalScope</code>, nó có thể gây memory leak và giữ coroutine tồn tại ngay cả sau khi <strong>Activity</strong> hoặc <strong>Fragment</strong> khởi chạy nó đã bị bỏ qua.</li><li>Bạn không nên truyền <strong>coroutine scope</strong> như một tham số, thay vào đó hãy sử dụng function <code>coroutineScope</code>.</li></ul><h1 id=các-function-của-coroutine-scope>Các function của Coroutine scope</h1><ul><li><code>coroutineScope</code>: suspend function, dùng để bắt đầu một scope và trả về giá trị do tham số của function tạo ra.</li><li><code>supervisorScope</code>: tương tự <code>coroutineScope</code> nhưng nó override <strong>Job</strong> của context, vì vậy function không bị cancel khi coroutine con throw một Exception.</li><li><code>withContext</code>: tương tự <code>coroutineScope</code> nhưng cho phép thực hiện một số thay đổi trong scope (thường được sử dụng để set <strong>Dispatcher</strong>).</li><li><code>withTimeout</code>: tương tự <code>coroutineScope</code> nhưng đặt giới hạn thời gian cho phần body và nếu quá lâu sẽ bị hủy. Throw một <code>TimeoutCancellationException</code>.</li><li><code>withTimeoutOrNull</code>: tương tự <code>withTimeout</code> nhưng sẽ trả về <code>null</code> thay vì throw Exception khi hết thời gian.</li></ul><h1 id=chạy-song-song>Chạy song song</h1><p>Khi bạn muốn thực hiện hai tác vụ cùng lúc và đợi kết quả của cả hai trước khi trả về kết quả:</p><h2 id=khi-bạn-có-quyền-truy-cập-vào-một-scope-ví-dụ-từ-viewmodel>Khi bạn có quyền truy cập vào một scope (ví dụ từ ViewModel)</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>suspend</span> <span class=k>fun</span> <span class=nf>getConfigFromAPI</span><span class=p>():</span> <span class=n>UserConfig</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// thực hiện lệnh gọi API tại đây hoặc bất kỳ suspend fun nào
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>suspend</span> <span class=k>fun</span> <span class=nf>getSongsFromAPI</span><span class=p>():</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Song</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// thực hiện lệnh gọi API tại đây hoặc bất kỳ suspend fun nào
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>getConfigAndSongs</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// scope có thể là bất kỳ scope nào bạn muốn, trường hợp điển hình sẽ là viewModelScope
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>scope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>userConfig</span> <span class=p>=</span> <span class=n>async</span> <span class=p>{</span> <span class=n>getConfigFromAPI</span><span class=p>()</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>songs</span> <span class=p>=</span> <span class=n>async</span> <span class=p>{</span> <span class=n>getSongsFromAPI</span><span class=p>()</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Pair</span><span class=p>(</span><span class=n>userConfig</span><span class=p>.</span><span class=n>await</span><span class=p>(),</span> <span class=n>songs</span><span class=p>.</span><span class=n>await</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Giả sử bạn có API được phân trang và bạn muốn tải xuống tất cả các trang trước khi hiển thị chúng cho người dùng, nhưng bạn muốn tải song song tất cả các trang:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>suspend</span> <span class=k>fun</span> <span class=nf>getSongsFromAPI</span><span class=p>(</span><span class=n>page</span><span class=p>:</span> <span class=n>Int</span><span class=p>):</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Song</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// thực hiện lệnh gọi API
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=k>val</span> <span class=py>totalNumberOfPages</span> <span class=p>=</span> <span class=m>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>fun</span> <span class=nf>getAllSongs</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// scope có thể là bất kỳ scope nào bạn muốn, trường hợp điển hình là viewModelScope
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>scope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>allNews</span> <span class=p>=</span> <span class=p>(</span><span class=m>0</span> <span class=n>until</span> <span class=n>totalNumberOfPages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                  <span class=p>.</span><span class=n>map</span> <span class=p>{</span> <span class=n>page</span> <span class=o>-&gt;</span> <span class=n>async</span> <span class=p>{</span> <span class=n>getSongsFromAPI</span><span class=p>(</span><span class=n>page</span><span class=p>)</span> <span class=p>}</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>                  <span class=p>.</span><span class=n>flatMap</span> <span class=p>{</span> <span class=k>it</span><span class=p>.</span><span class=n>await</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Lưu ý về <code>async</code>/<code>await</code>: coroutine sẽ được bắt đầu ngay lập tức khi nó được gọi. <code>async</code> trả về một object thuộc loại <code>Deferred&lt;T></code> (trong ví dụ của chúng ta là <code>Deferred&lt;List&lt;Song>></code>). <code>Deferred</code> có suspend function <code>await</code> trả về giá trị khi nó sẵn sàng.</p></blockquote><h2 id=khi-bạn-không-có-quyền-truy-cập-vào-một-scope-ví-dụ-từ-một-repository>Khi bạn không có quyền truy cập vào một scope (ví dụ từ một repository)</h2><p>Từ repository hoặc use case của bạn, bạn muốn định nghĩa một coroutine sẽ bắt đầu song song 2 (hoặc nhiều) lệnh gọi. Vấn đề là bạn cần một scope để sử dụng <code>async</code> nhưng bạn không ở trong <code>viewModel</code> hoặc presenter nên bạn không có quyền truy cập vào scope của mình ở đây (hãy nhớ quy tắc của chúng ta là không nên truyền scope như một tham số).</p><p>Từ ví dụ ở trên, chúng ta sửa lại một chút như sau:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>suspend</span> <span class=k>fun</span> <span class=nf>getConfigAndSongs</span><span class=p>():</span> <span class=n>Pair</span><span class=p>&lt;</span><span class=n>UserConfig</span><span class=p>,</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Song</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>coroutineScope</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>userConfig</span> <span class=p>=</span> <span class=n>async</span> <span class=p>{</span> <span class=n>getConfigFromAPI</span><span class=p>()</span> <span class=p>}</span> 
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>songs</span> <span class=p>=</span> <span class=n>async</span> <span class=p>{</span> <span class=n>getSongsFromAPI</span><span class=p>()}</span> 
</span></span><span class=line><span class=cl>    <span class=n>Pair</span><span class=p>(</span><span class=n>userConfig</span><span class=p>.</span><span class=n>await</span><span class=p>(),</span> <span class=n>songs</span><span class=p>.</span><span class=n>await</span><span class=p>())</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=dọn-dẹp-khi-coroutine-bị-cancel>Dọn dẹp khi Coroutine bị cancel</h1><p>Nếu một coroutine bị hủy thì nó sẽ có trạng thái <code>cancelling</code> trước khi chuyển sang <code>cancelled</code>. Khi một coroutine bị hủy, chúng ta sẽ có thời gian để thực hiện một số tác vụ dọn dẹp nếu cần thiết (chẳng hạn như dọn dẹp local database hoặc gọi API để cho server biết rằng tác vụ không thành công).</p><p>Chúng ta có thể sử dụng <code>finally</code> để thực hiện một tác vụ:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>viewModelScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// gọi một số suspend function tại đây
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// thực hiện tác vụ dọn dẹp tại đây
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Nhưng không được phép gọi suspend function trong quá trình dọn dẹp. Nếu bạn cần gọi suspend function, bạn sẽ cần phải làm như sau:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>viewModelScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// gọi một số suspend function tại đây
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>withContext</span><span class=p>(</span><span class=n>NonCancellable</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// thực hiện suspend function dọn dẹp tại đây
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Lưu ý: Việc cancel sẽ xảy ra tại điểm suspend đầu tiên. Vì vậy việc cancel sẽ không xảy ra nếu chúng không có bất kỳ suspend function nào.</p></blockquote><h1 id=dọn-dẹp-coroutine-khi-hoàn-thành>Dọn dẹp Coroutine khi hoàn thành</h1><p>Tương tự như việc dọn dẹp khi một coroutine bị hủy, bạn có thể muốn thực hiện một thao tác khi coroutine đạt đến trạng thái cuối cùng (<code>completed</code> hoặc <code>cancelled</code>).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>suspend</span> <span class=k>fun</span> <span class=nf>myFunction</span><span class=p>()</span> <span class=p>=</span> <span class=n>coroutineScope</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>job</span> <span class=p>=</span> <span class=n>launch</span> <span class=p>{</span> <span class=cm>/* suspend function tại đây */</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>job</span><span class=p>.</span><span class=n>invokeOnCompletion</span> <span class=p>{</span> <span class=n>exception</span><span class=p>:</span> <span class=n>Throwable</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// do something here
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=làm-cách-nào-để-không-cancel-coroutine-khi-một-trong-các-phần-tử-con-của-nó-bị-lỗi>Làm cách nào để KHÔNG cancel Coroutine khi một trong các phần tử con của nó bị lỗi</h1><p>Bạn có thể sử dụng <code>SupervisorJob</code> và nó sẽ bỏ qua tất cả các exception ở con của nó.</p><h2 id=tạo-coroutine-scope-của-bạn>Tạo coroutine scope của bạn</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>scope</span> <span class=p>=</span> <span class=n>CoroutineScope</span><span class=p>(</span><span class=n>SupervisorJob</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=c1>// nếu một coroutine mắc lỗi thì coroutine còn lại sẽ không bị hủy
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>scope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span> <span class=n>myFirstCoroutine</span><span class=p>()</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>scope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span> <span class=n>mySecondCoroutine</span><span class=p>()</span> <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=sử-dụng-scope-function>Sử dụng scope function</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>suspend</span> <span class=k>fun</span> <span class=nf>myFunction</span><span class=p>()</span> <span class=p>=</span> <span class=n>supervisorScope</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// nếu một coroutine xảy ra lỗi thì coroutine kia sẽ không bị hủy
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>launch</span> <span class=p>{</span> <span class=n>myFirstCoroutine</span><span class=p>()</span> <span class=p>}</span> 
</span></span><span class=line><span class=cl>    <span class=n>launch</span> <span class=p>{</span> <span class=n>mySecondCoroutine</span><span class=p>()</span> <span class=p>}</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=bắt-exception>Bắt exception</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>suspend</span> <span class=k>fun</span> <span class=nf>myFunction</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>coroutineScope</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>launch</span> <span class=p>{</span> <span class=n>myFirstCoroutine</span><span class=p>()</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>Exception</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// xử lý lỗi tại đây
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>coroutineScope</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>launch</span> <span class=p>{</span> <span class=n>mySecondCoroutine</span><span class=p>()</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>e</span><span class=p>:</span> <span class=n>Exception</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// xử lý lỗi tại đây
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>CancellationException</code> không truyền tới coroutine cha, chỉ coroutine hiện tại bị cancel. Có thể kế thừa <code>CancellationException</code> để tạo loại exception của riêng bạn, và nó cũng sẽ không truyền tới coroutine cha.</p><h1 id=định-nghĩa-tác-vụ-mặc-định-trong-trường-hợp-có-exception>Định nghĩa tác vụ mặc định trong trường hợp có exception</h1><p>Chúng ta có thể sử dụng <code>CoroutineExceptionHandler</code>. Ví dụ, dùng để tự động đăng xuất người dùng khi server trả về lỗi 401.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>handler</span> <span class=p>=</span> <span class=n>CoroutineExceptionHandler</span> <span class=p>{</span> <span class=n>context</span><span class=p>,</span> <span class=n>exception</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// định nghĩa tác vụ mặc định như hiển thị hộp thoại hoặc thông báo lỗi
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=py>scope</span> <span class=p>=</span> <span class=n>CoroutineScope</span><span class=p>(</span><span class=n>SupervisorJob</span><span class=p>()</span> <span class=p>+</span> <span class=n>handler</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=n>scope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span> <span class=cm>/* gọi suspend function tại đây */</span> <span class=p>}</span> 
</span></span><span class=line><span class=cl><span class=n>scope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span> <span class=cm>/* gọi suspend function tại đây */</span> <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=chạy-một-tác-vụ-không-cần-thiết>Chạy một tác vụ không cần thiết</h1><p>Nếu bạn muốn chạy một suspend function mà không ảnh hưởng đến các function khác (ví dụ nếu nó gây ra lỗi thì chỉ hàm này sẽ KHÔNG cancel coroutine, nhưng các hàm khác nếu gây ra lỗi thì vẫn sẽ cancel coroutine bình thường). Ví dụ điển hình là các function analytics.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>nonEssentialOperationScope</span> <span class=p>=</span> <span class=n>CoroutineScope</span><span class=p>(</span><span class=n>SupervisorJob</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=k>suspend</span> <span class=k>fun</span> <span class=nf>getConfigAndSongs</span><span class=p>():</span> <span class=n>Pair</span><span class=p>&lt;</span><span class=n>UserConfig</span><span class=p>,</span> <span class=n>List</span><span class=p>&lt;</span><span class=n>Song</span><span class=p>&gt;</span> <span class=p>=</span> <span class=n>coroutineScope</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>userConfig</span> <span class=p>=</span> <span class=n>async</span> <span class=p>{</span> <span class=n>getConfigFromAPI</span><span class=p>()</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>songs</span> <span class=p>=</span> <span class=n>async</span> <span class=p>{</span> <span class=n>getSongsFromAPI</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>    <span class=n>nonEssentialOperationScope</span><span class=p>.</span><span class=n>launch</span> <span class=p>{</span> <span class=cm>/* tác vụ không cần thiết ở đây */</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>Pair</span><span class=p>(</span><span class=n>userConfig</span><span class=p>.</span><span class=n>await</span><span class=p>(),</span> <span class=n>songs</span><span class=p>.</span><span class=n>await</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Lý tưởng nhất là bạn nên inject <code>nonEssentialOperationScope</code> vào class để dễ test hơn.</p><h1 id=chạy-một-tác-vụ-trên-single-thread-để-tránh-các-sự-cố-đồng-bộ>Chạy một tác vụ trên single thread để tránh các sự cố đồng bộ</h1><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>suspend</span> <span class=k>fun</span> <span class=nf>myFunction</span><span class=p>()</span> <span class=p>=</span> <span class=n>withContext</span><span class=p>(</span><span class=nc>Dispatchers</span><span class=p>.</span><span class=nc>Default</span><span class=p>.</span><span class=n>limiteParallelism</span><span class=p>(</span><span class=m>1</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// suspend function tại đây
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// Cũng có thể sử dụng Dispatchers.IO
</span></span></span></code></pre></td></tr></table></div></div><h2 id=các-cách-tiếp-cận-khác-để-tránh-sự-cố-đồng-bộ-hóa-với-multithreading>Các cách tiếp cận khác để tránh sự cố đồng bộ hóa với multithreading</h2><p>Bạn có thể sử dụng <code>AtomicReference</code> (từ Java)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>private</span> <span class=k>val</span> <span class=py>myList</span> <span class=p>=</span> <span class=n>AtomicReference</span><span class=p>(</span><span class=n>listOf</span><span class=p>(</span> <span class=cm>/* thêm object vào đây */</span> <span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>suspend</span> <span class=k>fun</span> <span class=nf>fetchNewElement</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=py>myNewElement</span> <span class=p>=</span> <span class=c1>// fetch phần tử mới tại đây
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>myList</span><span class=p>.</span><span class=n>getAndSet</span> <span class=p>{</span> <span class=k>it</span> <span class=p>+</span> <span class=n>myNewElement</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Hoặc với <code>Mutex</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=k>val</span> <span class=py>mutex</span> <span class=p>=</span> <span class=n>Mutex</span><span class=p>()</span> 
</span></span><span class=line><span class=cl><span class=k>private</span> <span class=k>var</span> <span class=py>myList</span> <span class=p>=</span> <span class=n>listOf</span><span class=p>(</span> <span class=cm>/* thêm object vào đây */</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>suspend</span> <span class=k>fun</span> <span class=nf>fetchNewElement</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mutex</span><span class=p>.</span><span class=n>withLock</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=py>myNewElement</span> <span class=p>=</span> <span class=c1>// fetch phần tử mới tại đây
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>myList</span> <span class=o>+=</span> <span class=n>myNewElement</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=tránh-gửi-lại-một-coroutine-đến-cùng-một-dispatcher>Tránh gửi lại một coroutine đến cùng một dispatcher</h1><p>Tránh chi phí không cần thiết khi chuyển đổi dispatcher nếu chúng ta đã sử dụng <code>Dispatcher.Main</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=c1>// điều này sẽ chỉ dispatch nếu cần thiết
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>suspend</span> <span class=k>fun</span> <span class=nf>myFunction</span><span class=p>()</span> <span class=p>=</span> <span class=n>withContext</span><span class=p>(</span><span class=nc>Dispatcher</span><span class=p>.</span><span class=nc>Main</span><span class=p>.</span><span class=n>immediate</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// suspend fun tại đây
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Hiện tại chỉ <code>Dispatchers.Main</code> hỗ trợ <code>immediate</code> dispatching.</p><p>Cảm ơn bạn đã đọc đến đây. Nếu bạn có kiến thức hay ho hoặc tip về Kotlin Coroutines, đừng ngần ngại comment chia sẻ với mình nhé!</p><h1 id=reference>Reference</h1><ul><li><a class=link href=https://medium.com/@galou.minisini/advanced-kotlin-coroutine-cheat-sheet-for-android-engineer-15e0d180fc1f target=_blank rel=noopener>https://medium.com/@galou.minisini/advanced-kotlin-coroutine-cheat-sheet-for-android-engineer-15e0d180fc1f</a></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/kotlin/>Kotlin</a>
<a href=/tags/android/>Android</a>
<a href=/tags/coroutines/>Coroutines</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/kotlin-flow-cheat-sheet-3/><div class=article-image><img src=/p/kotlin-flow-cheat-sheet-3/cheat_sheet.693580b63998c07c78483b5a2f6bbda9_hu_390799656209e09c.webp width=250 height=150 loading=lazy alt="Featured image of post Kotlin Flow cheat sheet phần 3: SharedFlow và StateFlow" data-key=kotlin-flow-cheat-sheet-3 data-hash="md5-aTWAtjmYwHx4SDtaL2u9qQ=="></div><div class=article-details><h2 class=article-title>Kotlin Flow cheat sheet phần 3: SharedFlow và StateFlow</h2></div></a></article><article class=has-image><a href=/p/kotlin-flow-cheat-sheet-2/><div class=article-image><img src=/p/kotlin-flow-cheat-sheet-2/cheat_sheet.693580b63998c07c78483b5a2f6bbda9_hu_390799656209e09c.webp width=250 height=150 loading=lazy alt="Featured image of post Kotlin Flow cheat sheet phần 2: Flow" data-key=kotlin-flow-cheat-sheet-2 data-hash="md5-aTWAtjmYwHx4SDtaL2u9qQ=="></div><div class=article-details><h2 class=article-title>Kotlin Flow cheat sheet phần 2: Flow</h2></div></a></article><article class=has-image><a href=/p/kotlin-flow-cheat-sheet-1/><div class=article-image><img src=/p/kotlin-flow-cheat-sheet-1/cheat_sheet.693580b63998c07c78483b5a2f6bbda9_hu_390799656209e09c.webp width=250 height=150 loading=lazy alt="Featured image of post Kotlin Flow cheat sheet phần 1: Channel" data-key=kotlin-flow-cheat-sheet-1 data-hash="md5-aTWAtjmYwHx4SDtaL2u9qQ=="></div><div class=article-details><h2 class=article-title>Kotlin Flow cheat sheet phần 1: Channel</h2></div></a></article><article class=has-image><a href=/p/kotlin-coroutines-dispatchers/><div class=article-image><img src=/p/kotlin-coroutines-dispatchers/dispatchers.3d7c85f89a7f740c7da44f291d96b1c8_hu_a397df491ef1bd1.webp width=250 height=150 loading=lazy alt="Featured image of post Dispatchers in Kotlin Coroutines" data-key=kotlin-coroutines-dispatchers data-hash="md5-PXyF+Jp/dAx9pE8pHZaxyA=="></div><div class=article-details><h2 class=article-title>Dispatchers in Kotlin Coroutines</h2></div></a></article><article class=has-image><a href=/p/data-store/><div class=article-image><img src=/p/data-store/datastore.157bda8acaee0bb97a2b1f2e892d3af8_hu_c80adbe382a11db2.webp width=250 height=150 loading=lazy alt="Featured image of post DataStore - The Perfect Piece for the Kotlin Coroutines Puzzle" data-key=data-store data-hash="md5-FXvaisruC7l6Kx8uiS06+A=="></div><div class=article-details><h2 class=article-title>DataStore - The Perfect Piece for the Kotlin Coroutines Puzzle</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//henry-techie.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2019 -
2025 Henry Techie</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script data-goatcounter=https://henry-techie.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html>